name: "[CI/CD] Release"

on:
  workflow_run:
    workflows: ["[CI/CD] Build"]
    branches: 
      - main
      - feature/improvements
    types: 
      - completed

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: orca-one-artifacts
          path: .pio/build/**/OrcaOne*.bin

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASES_TOKEN }}
        with:
          tag_name: ${{ vars.CURRENT_VERSION }}.${{ github.run_number }}
          release_name: ${{ vars.CURRENT_VERSION }}.${{ github.run_number }}
          draft: true
          prerelease: false
          body: |
            Release automatically generated by CI/CD workflow.

      - name: Upload Binaries Release Assets
        run: |
          for file in $(find .pio/build/** -name 'OrcaOne*.bin'); do
            echo "Uploading $file"
            curl \
              --http1.1 \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.RELEASES_TOKEN }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -H "Content-Type: application/octet-stream" \
              "${{ steps.create_release.outputs.upload_url }}=$(basename $file)"
              --data-binary @"$file" \
          done
